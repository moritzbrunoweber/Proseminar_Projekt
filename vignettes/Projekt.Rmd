---
title: "Projekt"
output: html_document
---

```{r}
library(ncdf4)
library(terra)
library(here)
library(ggplot2)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(dplyr)

# define file paths
file_path <- "C:/Users/Moritz.weber/Desktop/lokale Dateien/Uni/HS2025/Proseminar_Applied_Geodata_Science/data_external/GRAVIS-3_COSTG_0200_TWS_GRID_GFZ_0001.nc"    #insert path to tws-data
file_path_m1 <- "C:/Users/Moritz.weber/Desktop/lokale Dateien/Uni/HS2025/Proseminar_Applied_Geodata_Science/data_external/tree_cover_new/2000"    #insert file path to folder containing tree cover data for the period 2000-2001
file_path_m2 <- "C:/Users/Moritz.weber/Desktop/lokale Dateien/Uni/HS2025/Proseminar_Applied_Geodata_Science/data_external/tree_cover_new/2024"    #insert file path to folder containing tree cover data for the period 2024-2025
```

## Area of Interest

```{r}
coords <- matrix(c(
  -77.0000000,  6.0000000,   # Upper Left
  -48.0000000,  6.0000000,   # Upper Right
  -48.0000000, -18.0000000,   # Lower Right
  -77.0000000, -18.0000000,   # Lower Left
  -77.0000000,  6.0000000    # zurück zum Startpunkt
), ncol = 2, byrow = TRUE)

polygon_sf <- st_sf(
  geometry = st_sfc(st_polygon(list(coords))),
  crs = 4326
)

world <- ne_countries(scale = "medium", returnclass = "sf")

fig_aoi <- ggplot() +
  geom_sf(data = world, fill = "gray90", color = "gray50") +
  geom_sf(data = polygon_sf, fill = "lightblue", color = "darkblue", alpha = 0.6, size = 1) +
  coord_sf(
    xlim = c(-80, -30),
    ylim = c(-20, 15),
    expand = FALSE
  ) +
  labs(
    title = "Area of Interest",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal()

ggsave(
  filename = here("fig", "area_of_interest.png"),
  plot = fig_aoi,
  width = 8,
  height = 6,
  dpi = 300
)
```

## Data Processing TWS

```{r}
tws <- nc_open(file_path)

structure(tws)

time_vals <- ncvar_get(tws, "time")

time_units <- ncatt_get(tws, "time", "units")$value
calendar <- ncatt_get(tws, "time", "calendar")$value

time_units
calendar
head(time_vals)

origin <- as.POSIXct("2002-04-18 00:00:00", tz = "UTC")

time_dates <- origin + time_vals * 86400  # 86400 Sekunden pro Tag

head(time_dates)
tail(time_dates)

start_date1 <- as.POSIXct("2003-03-01", tz = "UTC")
end_date1   <- as.POSIXct("2004-03-31", tz = "UTC")

sel_idx1 <- which(time_dates >= start_date1 & time_dates <= end_date1)

time_dates[sel_idx1]

start_date2 <- as.POSIXct("2024-03-01", tz = "UTC")
end_date2   <- as.POSIXct("2025-03-31", tz = "UTC")

sel_idx2 <- which(time_dates >= start_date2 & time_dates <= end_date2)

time_dates[sel_idx2]

tws_rast <- rast(file_path)

tws1 <- tws_rast[[sel_idx1]]

time(tws1) <- time_dates[sel_idx1]

tws1

tws2 <- tws_rast[[sel_idx2]]

time(tws2) <- time_dates[sel_idx2]

tws2

tws1_mean <- mean(tws1, na.rm = TRUE)

plot(tws1_mean, main = "Mean TWS (Mar 2003 – Mar 2004)")

tws2_mean <- mean(tws2, na.rm = TRUE)

plot(tws2_mean, main = "Mean TWS (Mar 2024 – Mar 2025)")

tws1_mean_180 <- terra::rotate(tws1_mean)
tws2_mean_180 <- terra::rotate(tws2_mean)

ext(tws1_mean_180)
ext(tws2_mean_180)

polygon_vect <- vect(polygon_sf)

tws1_aoi <- mask(crop(tws1_mean_180, polygon_vect), polygon_vect)
tws2_aoi <- mask(crop(tws2_mean_180, polygon_vect), polygon_vect)

# Plotten
plot(tws1_aoi, main = "Mean TWS (Mar 2003 – Mar 2004) – AOI", col = viridis::viridis(100))
plot(st_geometry(polygon_sf), add = TRUE, border = "red", lwd = 2)

plot(tws2_aoi, main = "Mean TWS (Mar 2024 – Mar 2025) – AOI", col = viridis::viridis(100))
plot(st_geometry(polygon_sf), add = TRUE, border = "red", lwd = 2)


# Zeitreihe erstellen für Amplitude

years <- format(time(tws_rast), "%Y")
unique_years <- sort(unique(as.numeric(years)))
time(annual_amp) <- as.POSIXct(paste0(unique_years, "-07-01"), tz = "UTC")

annual_amp <- tapp(tws_rast, years, fun = function(x) {
  if (all(is.na(x))) {
    return(NA)
  } else {
    return(max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
  }
})

annual_amp <- terra::rotate(annual_amp)
ext(annual_amp)

annual_amp_aoi <- mask(crop(annual_amp, polygon_vect), polygon_vect)

plot(annual_amp_aoi)
```

## Data processing tree cover

```{r}

process_MOD44B_treecover <- function(hdf_folder, aoi, output_file) {
  hdf_files <- list.files(hdf_folder, pattern = "\\.hdf$", full.names = TRUE)
  if(length(hdf_files) == 0) stop("Keine HDF-Dateien im Ordner gefunden!")

  tree_rasters <- lapply(hdf_files, function(f) {
    sds_path <- sprintf('HDF4_EOS:EOS_GRID:"%s":MOD44B_250m_GRID:Percent_Tree_Cover', f)
    rast(sds_path)
  })

  mosaic_tree <- do.call(mosaic, tree_rasters)
  
  if (!identical(crs(mosaic_tree), crs(aoi))) {
    aoi <- project(aoi, crs(mosaic_tree))
  }
  
  tree_crop <- crop(mosaic_tree, aoi)
  tree_masked <- mask(tree_crop, aoi)
  
  plot(tree_masked, main = paste("MOD44B Tree Cover -", output_file))
 # writeRaster(tree_masked, output_file, overwrite = TRUE)
  
  return(tree_masked)
}

# Tree Cover für 2000
tree_2000 <- process_MOD44B_treecover(file_path_m1, polygon_vect, "MOD44B_TreeCover_2000_AOI.tif")
tree_2000[tree_2000 == 200] <- NA

# Tree Cover für 2024
tree_2024 <- process_MOD44B_treecover(file_path_m2, polygon_vect, "MOD44B_TreeCover_2024_AOI.tif")
tree_2024[tree_2024 == 200] <- NA

tree_cover_change <- tree_2024 - tree_2000

# plot(tree_cover_change, main = "tree_cover_change")

# adapt spatial resolution
tree_cover_change <- project(tree_cover_change, tws1_aoi)

tree_cover_change_resampled <- resample(tree_cover_change, tws1_aoi, method = "average")
plot(tree_cover_change_resampled, main = "tree_cover_change_resampled")

```

